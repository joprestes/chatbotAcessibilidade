# ============================================
# Pipeline CI/CD - Chatbot de Acessibilidade
# ============================================
# 
# Esta pipeline executa automaticamente:
# 1. Linting e verifica√ß√£o de tipos
# 2. Testes unit√°rios e de integra√ß√£o
# 3. Testes E2E com Playwright em m√∫ltiplos navegadores
#
# Executa em: push e pull requests para main/develop
# ============================================

name: CI

# ============================================
# Triggers: Quando a pipeline √© executada
# ============================================
on:
  # Executa quando h√° push nas branches principais
  push:
    branches: [ main, develop ]
  # Executa quando h√° pull request para essas branches
  pull_request:
    branches: [ main, develop ]

# ============================================
# Jobs: Tarefas executadas na pipeline
# ============================================

jobs:
  # ============================================
  # Job 1: Lint e Testes Unit√°rios/Integra√ß√£o
  # ============================================
  # Este job executa verifica√ß√µes r√°pidas que n√£o requerem servidor
  lint-and-unit:
    runs-on: ubuntu-latest  # Executa no Ubuntu mais recente
    
    steps:
      # Step 1: Baixa o c√≥digo do reposit√≥rio
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Configura Python 3.12
      # Cache: Acelera instala√ß√£o de depend√™ncias reutilizando cache do pip
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'  # Habilita cache do pip para builds mais r√°pidos
      
      # Step 3: Instala depend√™ncias do projeto
      # PYTHONUNBUFFERED: Garante que logs apare√ßam em tempo real
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        env:
          PYTHONUNBUFFERED: "1"  # Logs n√£o s√£o bufferizados
      
      # Step 4: Verifica qualidade do c√≥digo com Ruff
      # Ruff √© um linter r√°pido que verifica estilo e problemas comuns
      - name: Lint with ruff
        run: ruff check src/ tests/ || (echo "‚ùå Linting falhou" && exit 1)
      
      # Step 5: Verifica tipos com MyPy
      # MyPy verifica se os type hints est√£o corretos
      # N√£o cr√≠tico: avisos n√£o impedem a pipeline de continuar
      - name: Type check with mypy
        run: mypy src/ || echo "‚ö†Ô∏è Type checking com avisos (n√£o cr√≠tico)"
      
      # Step 6: Executa testes unit√°rios
      # Testes r√°pidos que verificam unidades individuais de c√≥digo
      # --tb=short: Mostra traceback resumido em caso de falha
      - name: Run unit tests
        run: pytest tests/unit/ -v -m "unit" --tb=short
        env:
          PYTHONUNBUFFERED: "1"
      
      # Step 7: Executa testes de integra√ß√£o
      # Testes que verificam integra√ß√£o entre componentes
      # FALLBACK_ENABLED=false: Desabilita fallback para testes mais r√°pidos
      - name: Run integration tests
        run: pytest tests/integration/ -v -m "integration" --tb=short
        env:
          PYTHONUNBUFFERED: "1"
          FALLBACK_ENABLED: "false"  # Desabilita fallback autom√°tico
  
  # ============================================
  # Job 2: Testes E2E (End-to-End)
  # ============================================
  # Este job executa testes completos que simulam uso real da aplica√ß√£o
  # Executa em m√∫ltiplos navegadores para garantir compatibilidade
  test-e2e:
    runs-on: ubuntu-latest
    needs: lint-and-unit  # S√≥ executa se o job anterior passou
    
    # ============================================
    # Matrix Strategy: Executa testes em paralelo
    # ============================================
    # Cria uma combina√ß√£o de Python version e navegadores
    # Resultado: 3 jobs paralelos (um para cada navegador)
    strategy:
      matrix:
        python-version: ["3.12"]
        browser: [chromium, firefox, webkit]  # 3 navegadores diferentes
    
    steps:
      # Step 1: Baixa o c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Configura Python (usando vers√£o da matrix)
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      # Step 3: Instala depend√™ncias e navegadores do Playwright
      # --with-deps: Instala depend√™ncias do sistema necess√°rias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Instala o navegador espec√≠fico da matrix (chromium, firefox ou webkit)
          playwright install --with-deps ${{ matrix.browser }}
      
      # Step 4: Inicia o servidor FastAPI em background
      # Este step √© cr√≠tico: os testes E2E precisam do servidor rodando
      - name: Start FastAPI server
        run: |
          echo "üöÄ Iniciando servidor FastAPI..."
          # Inicia servidor em background e salva logs
          uvicorn src.backend.api:app --host 0.0.0.0 --port 8000 > /tmp/uvicorn.log 2>&1 &
          SERVER_PID=$!
          echo "üìù PID do servidor: $SERVER_PID"
          
          # ============================================
          # Retry Loop: Aguarda servidor iniciar
          # ============================================
          # Tenta at√© 30 vezes (60 segundos total) verificar se servidor est√° pronto
          # Isso garante que o servidor tenha tempo de inicializar completamente
          echo "‚è≥ Aguardando servidor iniciar..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Servidor est√° respondendo!"
              curl -f http://localhost:8000/api/health
              exit 0
            fi
            echo "Tentativa $i/30: Servidor ainda n√£o est√° pronto..."
            sleep 2
          done
          
          # Se chegou aqui, servidor n√£o iniciou
          echo "‚ùå Servidor n√£o iniciou ap√≥s 60 segundos"
          echo "üìã Logs do servidor:"
          cat /tmp/uvicorn.log
          exit 1
        env:
          # Vari√°veis de ambiente necess√°rias para o servidor
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}  # Chave da API Google (secreto)
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}  # Chave OpenRouter (secreto)
          FALLBACK_ENABLED: "false"  # Desabilita fallback para testes mais r√°pidos
          LOG_LEVEL: "INFO"  # N√≠vel de log
          PYTHONUNBUFFERED: "1"  # Logs em tempo real
      
      # Step 5: Verifica se servidor est√° realmente funcionando
      # Double-check antes de executar testes caros
      - name: Verify server is running
        run: |
          echo "üîç Verificando se servidor est√° rodando..."
          curl -f http://localhost:8000/api/health || (echo "‚ùå Servidor n√£o est√° respondendo" && exit 1)
          echo "‚úÖ Servidor est√° funcionando corretamente"
      
      # Step 6: Executa testes E2E com Playwright
      # Estes testes simulam uso real: abrem navegador, interagem com a interface
      - name: Run E2E tests
        run: pytest tests/e2e/ -v -m "e2e" --tb=short
        env:
          # Configura√ß√µes do Playwright
          PLAYWRIGHT_BASE_URL: http://localhost:8000  # URL base para testes
          PLAYWRIGHT_HEADLESS: "true"  # Executa sem interface gr√°fica (mais r√°pido)
          PLAYWRIGHT_BROWSER: ${{ matrix.browser }}  # Navegador da matrix
          PLAYWRIGHT_RECORD_VIDEO: "false"  # N√£o grava v√≠deos (economiza espa√ßo)
          PLAYWRIGHT_ENABLE_TRACE: "true"  # Habilita trace para debug
          
          # Vari√°veis do servidor (necess√°rias para testes que fazem requisi√ß√µes)
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          FALLBACK_ENABLED: "false"
          LOG_LEVEL: "INFO"
          PYTHONUNBUFFERED: "1"
      
      # Step 7: Para o servidor (cleanup)
      # if: always() = executa mesmo se testes falharem
      # Importante para n√£o deixar processos √≥rf√£os rodando
      - name: Stop FastAPI server
        if: always()  # Sempre executa, mesmo em caso de falha
        run: |
          echo "üõë Parando servidor..."
          pkill -f "uvicorn src.backend.api:app" || true  # || true = n√£o falha se processo n√£o existir
          sleep 2
      
      # Step 8: Faz upload de relat√≥rios e cobertura
      # if: always() = sempre faz upload, mesmo se testes falharem
      # √ötil para debug: voc√™ pode baixar os relat√≥rios mesmo em caso de falha
      - name: Upload test reports
        if: always()  # Sempre faz upload, mesmo em caso de falha
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.browser }}  # Nome √∫nico por navegador
          path: |
            tests/reports/  # Relat√≥rios HTML, screenshots, traces
            htmlcov/  # Relat√≥rio de cobertura de c√≥digo
          retention-days: 7  # Mant√©m arquivos por 7 dias (economiza espa√ßo)

